<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיפוש נסיעות רכבת ישראל</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div id="boot-splash" class="boot-splash" aria-live="polite">
        <div class="boot-splash-card">
            <img src="app-icon.png" alt="Rail Dashboard" class="boot-splash-icon">
            <p class="boot-splash-text">טוען את האפליקציה...</p>
        </div>
    </div>

    <div class="bg-orb orb-a"></div>
    <div class="bg-orb orb-b"></div>

    <main class="page">
        <header class="topbar">
            <p class="eyebrow">Israel Rail</p>
            <h1>חיפוש לכל תחנה ולכל נסיעה</h1>
            <p class="subtitle">בחר תחנת מוצא ויעד מתוך כל תחנות רכבת ישראל, וקבל את כל הנסיעות לתאריך והשעה שבחרת.</p>
        </header>
        
        <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
            <div class="loading-card">
                <div class="loading-title" id="loading-text">טוען נתונים...</div>
                <div class="train-loader">
                    <div class="train-track"></div>
                    <div class="train-runner">🚆</div>
                </div>
            </div>
        </div>

        <section class="search-panel">
            <div class="search-grid">
                <div class="field">
                    <label for="from-input">תחנת מוצא</label>
                    <input id="from-input" placeholder="הקלד שם תחנה" autocomplete="off">
                </div>

                <div class="swap-wrap">
                    <button id="swap-btn" class="icon-button" aria-label="החלפת כיוון">
                        <i data-lucide="arrow-up-down"></i>
                    </button>
                </div>

                <div class="field">
                    <label for="to-input">תחנת יעד</label>
                    <input id="to-input" placeholder="הקלד שם תחנה" autocomplete="off">
                </div>

                <div class="field small">
                    <label for="date-picker">תאריך</label>
                    <input type="date" id="date-picker">
                </div>

                <div class="field small">
                    <label for="time-picker">שעה</label>
                    <input type="time" id="time-picker">
                </div>

                <div class="actions">
                    <button id="search-btn" class="btn-primary">
                        <i data-lucide="search" size="18"></i>
                        חפש נסיעות
                    </button>
                    <button id="all-day-btn" class="btn-secondary">
                        <i data-lucide="calendar-days" size="18"></i>
                        כל היום
                    </button>
                </div>
            </div>

            <p id="search-hint" class="hint">טוען תחנות...</p>
        </section>

        <section class="results-panel">
            <div class="results-header">
                <h2 id="results-title">תוצאות</h2>
                <span id="results-count" class="badge">0 נסיעות</span>
            </div>
            <div id="results-body" class="results-body">
                <div class="empty-state">בחר תחנות ולחץ "חפש נסיעות"</div>
            </div>
        </section>

        <section class="results-panel">
            <div class="results-header">
                <h2>זמן אמת בתחנה</h2>
                <span id="board-count" class="badge">0 רכבות</span>
            </div>
            <div class="board-controls">
                <div class="field">
                    <label for="board-station-input">תחנה</label>
                    <input id="board-station-input" placeholder="הקלד שם תחנה" autocomplete="off">
                </div>
                <div class="field small">
                    <label for="board-window">טווח</label>
                    <select id="board-window">
                        <option value="30" selected>30 דקות</option>
                        <option value="60">60 דקות</option>
                        <option value="90">90 דקות</option>
                        <option value="120">120 דקות</option>
                    </select>
                </div>
                <div class="actions">
                    <button id="board-btn" class="btn-primary">
                        <i data-lucide="radio" size="18"></i>
                        הצג זמן אמת
                    </button>
                </div>
            </div>
            <p id="board-hint" class="hint">בחר תחנה כדי לראות את כל הרכבות הקרובות שעוברות בה.</p>
            <div id="board-body" class="results-body">
                <div class="empty-state">אין נתונים להצגה</div>
            </div>
        </section>

        <footer class="site-credit" aria-label="credit">
            Created by Itamar Yehuda
        </footer>
    </main>
    
    <div id="station-suggestions" class="station-suggestions" hidden></div>

    <script>
        let stations = [];
        let stationsByLabel = new Map();
        let boardRowsRaw = [];
        let boardStationCurrent = null;
        let activeRequests = 0;
        let activeSuggestionInput = null;
        const MIN_CHARS_FOR_SUGGESTIONS = 3;

        function stationLabel(station) {
            if (station.heb && station.eng) return `${station.heb} | ${station.eng} (${station.id})`;
            return `${station.name} (${station.id})`;
        }

        function parseStationInput(rawValue) {
            const value = (rawValue || '').trim();
            if (!value) return null;

            if (stationsByLabel.has(value)) {
                return stationsByLabel.get(value);
            }

            const normalized = value.toLowerCase();
            const directId = Number(normalized);
            if (!Number.isNaN(directId)) {
                const byId = stations.find(s => s.id === directId);
                if (byId) return byId;
            }

            const candidate = stations.find(s => {
                const name = String(s.name || '').toLowerCase();
                const heb = String(s.heb || '').toLowerCase();
                const eng = String(s.eng || '').toLowerCase();
                return name.includes(normalized) || heb.includes(normalized) || eng.includes(normalized);
            });

            return candidate || null;
        }

        function formatTime(value) {
            if (!value) return '--:--';
            if (value.includes('T')) {
                const parts = value.split('T');
                if (parts[1] && parts[1].length >= 5) return parts[1].slice(0, 5);
            }
            if (value.length >= 5 && value.includes(':')) return value.slice(0, 5);
            return '--:--';
        }

        function routeStops(route) {
            const allStops = [];
            route.trains.forEach(train => train.stops.forEach(stop => allStops.push(stop)));
            return allStops.filter((s, i) => i === 0 || s.name !== allStops[i - 1].name);
        }

        function minutesBetween(fromIso, toIso) {
            const from = new Date(fromIso);
            const to = new Date(toIso);
            if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) return null;
            return Math.max(0, Math.round((to - from) / 60000));
        }

        function transferRows(route) {
            if (!route.trains || route.trains.length < 2) return [];
            const rows = [];
            for (let i = 0; i < route.trains.length - 1; i += 1) {
                const current = route.trains[i];
                const next = route.trains[i + 1];
                const station = current.dst || next.src || 'תחנה לא ידועה';
                const fromPlatform = current.dst_platform || (current.stops?.[current.stops.length - 1]?.platform) || '-';
                const toPlatform = next.platform || (next.stops?.[0]?.platform) || '-';
                const wait = minutesBetween(current.arrival, next.departure);
                rows.push({
                    station,
                    fromPlatform,
                    toPlatform,
                    wait,
                });
            }
            return rows;
        }

        function stopsWithTransferMarkers(route) {
            const stops = routeStops(route);
            const transfers = transferRows(route);
            if (!transfers.length) {
                return stops.map(stop => ({ type: 'stop', stop }));
            }

            const markersByStation = new Map();
            transfers.forEach((transfer, idx) => {
                const key = transfer.station;
                if (!markersByStation.has(key)) markersByStation.set(key, []);
                markersByStation.get(key).push({
                    ...transfer,
                    index: idx + 1,
                });
            });

            const items = [];
            stops.forEach(stop => {
                items.push({ type: 'stop', stop });
                const markers = markersByStation.get(stop.name) || [];
                markers.forEach(marker => items.push({ type: 'transfer', marker }));
            });

            return items;
        }

        async function fetchJson(url) {
            const response = await fetch(url);
            const payload = await response.json();
            if (!response.ok) throw new Error(payload.error || 'Request failed');
            return payload;
        }

        function showLoading(text) {
            activeRequests += 1;
            const overlay = document.getElementById('loading-overlay');
            const label = document.getElementById('loading-text');
            label.textContent = text || 'טוען נתונים...';
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            activeRequests = Math.max(0, activeRequests - 1);
            if (activeRequests === 0) {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function hideBootSplash() {
            const splash = document.getElementById('boot-splash');
            if (!splash || splash.dataset.hidden === '1') return;
            splash.dataset.hidden = '1';
            splash.classList.add('boot-splash-hidden');
            setTimeout(() => {
                splash.style.display = 'none';
            }, 280);
        }

        async function loadStations() {
            const hint = document.getElementById('search-hint');
            try {
                stations = await fetchJson('/api/stations');
                stationsByLabel = new Map();

                stations.forEach(station => {
                    const label = stationLabel(station);
                    stationsByLabel.set(label, station);
                });

                hint.textContent = `נטענו ${stations.length} תחנות.`;
            } catch (error) {
                console.error(error);
                hint.textContent = 'שגיאה בטעינת תחנות. רענן את הדף.';
            }
        }

        function filteredStations(query) {
            const q = (query || '').trim().toLowerCase();
            const mobile = window.matchMedia('(max-width: 768px)').matches;
            const limit = mobile ? 9999 : 18;
            if (!q) return stations.slice(0, mobile ? 4 : 12);
            return stations.filter(s => {
                const name = String(s.name || '').toLowerCase();
                const heb = String(s.heb || '').toLowerCase();
                const eng = String(s.eng || '').toLowerCase();
                const id = String(s.id || '');
                return name.includes(q) || heb.includes(q) || eng.includes(q) || id.includes(q);
            }).slice(0, limit);
        }

        function hideSuggestions() {
            const box = document.getElementById('station-suggestions');
            box.hidden = true;
            box.innerHTML = '';
            activeSuggestionInput = null;
        }

        function positionSuggestions(input) {
            const box = document.getElementById('station-suggestions');
            const mobile = window.matchMedia('(max-width: 768px)').matches;
            if (mobile) {
                const viewport = window.visualViewport;
                const viewportTop = viewport ? viewport.offsetTop : 0;
                const viewportHeight = viewport ? viewport.height : window.innerHeight;
                const viewportBottom = viewportTop + viewportHeight;
                box.classList.add('mobile');
                box.style.right = 'auto';
                box.style.bottom = 'auto';

                const rect = input.getBoundingClientRect();
                const sidePadding = 8;
                const gap = 2;
                const maxHeight = Math.max(96, Math.min(170, Math.floor(viewportHeight * 0.30)));
                const spaceBelow = viewportBottom - rect.bottom - gap - sidePadding;
                const spaceAbove = rect.top - viewportTop - gap - sidePadding;

                const dropWidth = Math.min(rect.width, window.innerWidth - (sidePadding * 2));
                const left = Math.max(sidePadding, Math.min(rect.left, window.innerWidth - dropWidth - sidePadding));

                box.style.left = `${left}px`;
                box.style.width = `${dropWidth}px`;

                if (spaceBelow >= 110 || spaceBelow >= spaceAbove) {
                    const h = Math.max(96, Math.min(maxHeight, Math.floor(spaceBelow)));
                    box.style.maxHeight = `${h}px`;
                    box.style.top = `${Math.max(viewportTop + sidePadding, rect.bottom + gap)}px`;
                } else {
                    const h = Math.max(96, Math.min(maxHeight, Math.floor(spaceAbove)));
                    box.style.maxHeight = `${h}px`;
                    box.style.top = `${Math.max(viewportTop + sidePadding, rect.top - h - gap)}px`;
                }
                return;
            }

            const rect = input.getBoundingClientRect();
            box.classList.remove('mobile');
            box.style.left = `${rect.left + window.scrollX}px`;
            box.style.top = `${rect.bottom + window.scrollY + 6}px`;
            box.style.bottom = 'auto';
            box.style.right = 'auto';
            box.style.width = `${rect.width}px`;
            box.style.maxHeight = 'min(48vh, 340px)';
        }

        function showSuggestions(input) {
            if (!stations.length) return;
            const value = (input.value || '').trim();
            if (value.length < MIN_CHARS_FOR_SUGGESTIONS) {
                hideSuggestions();
                return;
            }
            const box = document.getElementById('station-suggestions');
            const options = filteredStations(input.value);
            if (!options.length) {
                hideSuggestions();
                return;
            }

            activeSuggestionInput = input;
            box.innerHTML = options.map(s => {
                const label = stationLabel(s);
                return `<button type="button" class="station-option" data-station-label="${label.replace(/"/g, '&quot;')}">${label}</button>`;
            }).join('');

            positionSuggestions(input);
            box.hidden = false;

            box.querySelectorAll('.station-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    input.value = btn.dataset.stationLabel || '';
                    hideSuggestions();
                    input.dispatchEvent(new Event('change'));
                });
            });
        }

        function setResultsHeader(fromName, toName, count) {
            document.getElementById('results-title').textContent = `${fromName} ← ${toName}`;
            document.getElementById('results-count').textContent = `${count} נסיעות`;
        }

        function renderResults(routes) {
            const body = document.getElementById('results-body');
            if (!routes.length) {
                body.innerHTML = '<div class="empty-state">לא נמצאו נסיעות עבור הבחירה הזו.</div>';
                return;
            }

            body.innerHTML = routes.map((route, idx) => {
                const timeline = stopsWithTransferMarkers(route);
                const transfers = transferRows(route);
                const stopCount = timeline.filter(item => item.type === 'stop').length;
                return `
                    <article class="trip-card">
                        <button class="trip-head" onclick="toggleDetails(${idx})">
                            <strong>${formatTime(route.start_time)}</strong>
                            <span class="arrow">→</span>
                            <strong>${formatTime(route.end_time)}</strong>
                            <span class="badge subtle">${stopCount} תחנות</span>
                            <i data-lucide="chevron-down" size="16"></i>
                        </button>
                        <div id="trip-details-${idx}" class="trip-details">
                            ${transfers.map((t, transferIdx) => `
                                <div class="transfer-note">
                                    <strong>החלפה ${transferIdx + 1}: ${t.station}</strong>
                                    <span>רציף יורדים: ${t.fromPlatform} · רציף עולים: ${t.toPlatform}${t.wait !== null ? ` · המתנה: ${t.wait} דק'` : ''}</span>
                                </div>
                            `).join('')}
                            ${timeline.map(item => `
                                ${item.type === 'stop' ? `
                                <div class="stop-row">
                                    <span>${item.stop.name}</span>
                                    <strong>${formatTime(item.stop.arrival || item.stop.departure)}</strong>
                                </div>
                                ` : `
                                <div class="transfer-row-inline">
                                    <strong>החלפה ${item.marker.index}</strong>
                                    <span>${item.marker.station} · רציף ${item.marker.fromPlatform} → ${item.marker.toPlatform}${item.marker.wait !== null ? ` · ${item.marker.wait} דק'` : ''}</span>
                                </div>
                                `}
                            `).join('')}
                        </div>
                    </article>
                `;
            }).join('');

            lucide.createIcons();
        }

        function renderBoard(rows) {
            const body = document.getElementById('board-body');
            document.getElementById('board-count').textContent = `${rows.length} רכבות`;
            if (!rows.length) {
                body.innerHTML = '<div class="empty-state">לא נמצאו רכבות בטווח הזמן שנבחר.</div>';
                return;
            }

            body.innerHTML = rows.map((row, idx) => `
                <article class="trip-card">
                    <button class="board-row" onclick="toggleBoardDetails(${idx})">
                        <div><strong>${row.line_name || `${row.src} - ${row.dest}`}</strong></div>
                        <div class="board-time">
                            <span>${row.eta_minutes ?? '?'} דק'</span>
                        </div>
                        <i data-lucide="chevron-down" size="16"></i>
                    </button>
                    <div id="board-details-${idx}" class="board-details">
                        ${Array.isArray(row.stops) ? row.stops.map(stop => `
                            <div class="stop-row">
                                <span>${stop.name}</span>
                                <strong>${formatTime(stop.time)}</strong>
                            </div>
                        `).join('') : ''}
                        <div class="board-meta">יציאה: ${formatTime(row.time)} · רציף ${row.platform || '-'} · רכבת ${row.train_number || '-'}</div>
                    </div>
                </article>
            `).join('');

            lucide.createIcons();
        }

        function boardLineMeta(row, station) {
            const stops = Array.isArray(row.stops) ? row.stops : [];
            let idx = stops.findIndex(s => String(s.id) === String(station.id));
            if (idx < 0) idx = stops.findIndex(s => s.name === station.name);
            if (idx < 0) idx = 0;

            const nextStop = stops[idx + 1]?.name || '';
            const prevStop = stops[idx - 1]?.name || '';
            const directionKey = nextStop ? `to:${nextStop}` : (prevStop ? `from:${prevStop}` : `line:${row.line_name}`);
            const endName = stops.length ? stops[stops.length - 1].name : (row.dest || '');
            const score = stops.length;
            return { directionKey, endName, score };
        }

        function filterTerminalLines(rows, station) {
            if (!rows.length || !station) return rows;
            const preferredEndByDirection = new Map();

            rows.forEach(row => {
                const meta = boardLineMeta(row, station);
                const current = preferredEndByDirection.get(meta.directionKey);
                if (!current || meta.score > current.score) {
                    preferredEndByDirection.set(meta.directionKey, { endName: meta.endName, score: meta.score });
                }
            });

            return rows.filter(row => {
                const meta = boardLineMeta(row, station);
                const preferred = preferredEndByDirection.get(meta.directionKey);
                return preferred && preferred.endName === meta.endName;
            });
        }

        function applyBoardFilter() {
            const rows = filterTerminalLines(boardRowsRaw, boardStationCurrent);
            renderBoard(rows);
        }

        function toggleBoardDetails(idx) {
            const details = document.getElementById(`board-details-${idx}`);
            const isOpen = details.style.display === 'block';

            document.querySelectorAll('.board-details').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.board-row i').forEach(icon => icon.style.transform = 'rotate(0deg)');

            if (!isOpen) {
                details.style.display = 'block';
                const icon = details.previousElementSibling.querySelector('i');
                icon.style.transform = 'rotate(180deg)';
                icon.style.transition = 'transform 0.2s ease';
            }
        }

        function toggleDetails(idx) {
            const details = document.getElementById(`trip-details-${idx}`);
            const isOpen = details.style.display === 'block';

            document.querySelectorAll('.trip-details').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.trip-head i').forEach(icon => icon.style.transform = 'rotate(0deg)');

            if (!isOpen) {
                details.style.display = 'block';
                const icon = details.previousElementSibling.querySelector('i');
                icon.style.transform = 'rotate(180deg)';
                icon.style.transition = 'transform 0.2s ease';
            }
        }

        async function runSearch(forceAllDay) {
            const fromInput = document.getElementById('from-input').value;
            const toInput = document.getElementById('to-input').value;
            const fromStation = parseStationInput(fromInput);
            const toStation = parseStationInput(toInput);

            const body = document.getElementById('results-body');
            const hint = document.getElementById('search-hint');

            if (!fromStation || !toStation) {
                hint.textContent = 'בחר תחנות מתוך הרשימה (או הקלד שם מדויק/חלקי).';
                return;
            }

            if (fromStation.id === toStation.id) {
                hint.textContent = 'תחנת מוצא ויעד חייבות להיות שונות.';
                return;
            }

            const date = document.getElementById('date-picker').value;
            const time = forceAllDay ? '00:00' : document.getElementById('time-picker').value;
            const url = `/api/routes/${fromStation.id}/${toStation.id}?date=${date}&time=${time}`;

            body.innerHTML = '<div class="loading">טוען נסיעות...</div>';
            hint.textContent = 'מבצע חיפוש...';
            showLoading('מחפש נסיעות...');

            try {
                const routes = await fetchJson(url);
                setResultsHeader(fromStation.name, toStation.name, routes.length);
                renderResults(routes);
                hint.textContent = forceAllDay ? 'מציג את כל הנסיעות ליום הנבחר.' : 'מציג נסיעות החל מהשעה שנבחרה.';
            } catch (error) {
                console.error(error);
                body.innerHTML = '<div class="empty-state">שגיאה בטעינת הנתונים. נסה שוב.</div>';
                hint.textContent = `שגיאה: ${error.message}`;
            } finally {
                hideLoading();
            }
        }

        async function runStationRealtime() {
            const stationInput = document.getElementById('board-station-input').value;
            const station = parseStationInput(stationInput);
            const minutes = document.getElementById('board-window').value;
            const hint = document.getElementById('board-hint');
            const body = document.getElementById('board-body');

            if (!station) {
                hint.textContent = 'בחר תחנה מתוך הרשימה (או הקלד שם מדויק/חלקי).';
                return;
            }

            body.innerHTML = '<div class="loading">טוען זמן אמת...</div>';
            hint.textContent = `מחפש רכבות ל-${minutes} הדקות הקרובות...`;
            showLoading('מעדכן זמן אמת...');

            try {
                const rows = await fetchJson(`/api/station-board/${station.id}?upcoming=1&minutes=${minutes}&fast=1`);
                boardRowsRaw = rows;
                boardStationCurrent = station;
                applyBoardFilter();
                hint.textContent = `זמן אמת לתחנה: ${station.name}`;
            } catch (error) {
                console.error(error);
                body.innerHTML = '<div class="empty-state">שגיאה בטעינת זמן אמת. נסה שוב.</div>';
                hint.textContent = `שגיאה: ${error.message}`;
            } finally {
                hideLoading();
            }
        }

        function swapStations() {
            const from = document.getElementById('from-input');
            const to = document.getElementById('to-input');
            const temp = from.value;
            from.value = to.value;
            to.value = temp;
        }

        function initDateTime() {
            const now = new Date();
            document.getElementById('date-picker').valueAsDate = now;
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('time-picker').value = `${hh}:${mm}`;
        }

        document.getElementById('swap-btn').addEventListener('click', swapStations);
        document.getElementById('search-btn').addEventListener('click', () => runSearch(false));
        document.getElementById('all-day-btn').addEventListener('click', () => runSearch(true));
        document.getElementById('board-btn').addEventListener('click', runStationRealtime);

        document.getElementById('from-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') runSearch(false);
        });
        document.getElementById('to-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') runSearch(false);
        });
        document.getElementById('board-station-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') runStationRealtime();
        });

        ['from-input', 'to-input', 'board-station-input'].forEach((id) => {
            const input = document.getElementById(id);
            input.addEventListener('focus', () => {
                if (window.matchMedia('(max-width: 768px)').matches) {
                    setTimeout(() => {
                        input.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }, 80);
                }
                showSuggestions(input);
            });
            input.addEventListener('input', () => showSuggestions(input));
            input.addEventListener('blur', () => setTimeout(hideSuggestions, 120));
        });

        document.addEventListener('scroll', () => {
            if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
        }, true);
        window.addEventListener('resize', () => {
            if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
        });
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
            });
            window.visualViewport.addEventListener('scroll', () => {
                if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
            });
        }

        initDateTime();
        loadStations().then(() => {
            document.getElementById('search-hint').textContent = 'בחר תחנת מוצא ותחנת יעד כדי להתחיל חיפוש.';
        }).finally(() => {
            hideBootSplash();
        });

        window.addEventListener('load', () => {
            setTimeout(hideBootSplash, 300);
        });
        setTimeout(hideBootSplash, 6000);

        lucide.createIcons();
    </script>
</body>

</html>
