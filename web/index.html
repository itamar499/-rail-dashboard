<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיפוש נסיעות רכבת ישראל</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css?v=20260222b">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div id="boot-splash" class="boot-splash" aria-live="polite">
        <div class="boot-splash-card">
            <img src="app-icon.png" alt="Rail Dashboard" class="boot-splash-icon">
            <p class="boot-splash-text">טוען את האפליקציה...</p>
        </div>
    </div>

    <div class="bg-orb orb-a"></div>
    <div class="bg-orb orb-b"></div>

    <main class="page">
        <header class="topbar">
            <p class="eyebrow">מסילות בזמן אמת</p>
            <h1>חיפוש לכל תחנה ולכל נסיעה</h1>
            <p class="subtitle">בחר תחנת מוצא ויעד מתוך כל תחנות רכבת ישראל, וקבל את כל הנסיעות לתאריך והשעה שבחרת.</p>
            <div class="topbar-tools">
                <button id="theme-toggle" class="btn-secondary theme-toggle" type="button">
                    <i data-lucide="sun-moon" size="16"></i>
                    תצוגה: אוטומטי
                </button>
            </div>
        </header>
        
        <section class="search-panel">
            <div id="loading-overlay-search" class="loading-overlay" aria-hidden="true">
                <div class="loading-card">
                    <div class="loading-title" id="loading-text-search">טוען נתונים...</div>
                    <div class="train-loader">
                        <div class="train-track"></div>
                        <div class="train-runner">🚆</div>
                    </div>
                </div>
            </div>

            <div class="search-grid">
                <div class="field">
                    <label for="from-input">תחנת מוצא</label>
                    <input id="from-input" placeholder="הקלד שם תחנה" autocomplete="off">
                </div>

                <div class="swap-wrap">
                    <button id="swap-btn" class="icon-button" aria-label="החלפת כיוון">
                        <i data-lucide="arrow-up-down"></i>
                    </button>
                </div>

                <div class="field">
                    <label for="to-input">תחנת יעד</label>
                    <input id="to-input" placeholder="הקלד שם תחנה" autocomplete="off">
                </div>

                <div class="field small">
                    <label for="date-picker">תאריך</label>
                    <input type="date" id="date-picker">
                </div>

                <div class="field small">
                    <label for="time-picker">שעה</label>
                    <input type="time" id="time-picker">
                </div>

                <div class="actions">
                    <button id="search-btn" class="btn-primary">
                        <i data-lucide="search" size="18"></i>
                        חפש נסיעות
                    </button>
                    <button id="all-day-btn" class="btn-secondary">
                        <i data-lucide="calendar-days" size="18"></i>
                        כל היום
                    </button>
                </div>
            </div>

            <p id="search-hint" class="hint">טוען תחנות...</p>
        </section>

        <section class="results-panel">
            <div id="results-header" class="results-header" style="display:none;">
                <h2 id="results-title">תוצאות</h2>
                <span id="results-count" class="badge">טרם בוצע חיפוש</span>
            </div>
            <div id="results-body" class="results-body">
                <div class="empty-state">בחר תחנות ולחץ "חפש נסיעות"</div>
            </div>
        </section>

        <section class="results-panel">
            <div class="results-header">
                <h2>זמן אמת בתחנה</h2>
                <span id="board-count" class="badge">טרם בוצע חיפוש</span>
            </div>
            <div id="loading-overlay-board" class="loading-overlay" aria-hidden="true">
                <div class="loading-card">
                    <div class="loading-title" id="loading-text-board">טוען נתונים...</div>
                    <div class="train-loader">
                        <div class="train-track"></div>
                        <div class="train-runner">🚆</div>
                    </div>
                </div>
            </div>
            <div class="board-controls">
                <div class="field">
                    <label for="board-station-input">תחנה</label>
                    <input id="board-station-input" placeholder="הקלד שם תחנה" autocomplete="off">
                </div>
                <div class="field small">
                    <label for="board-window">טווח</label>
                    <select id="board-window">
                        <option value="30" selected>30 דקות</option>
                        <option value="60">60 דקות</option>
                        <option value="90">90 דקות</option>
                        <option value="120">120 דקות</option>
                    </select>
                </div>
                <div class="actions">
                    <button id="board-btn" class="btn-primary">
                        <i data-lucide="radio" size="18"></i>
                        הצג זמן אמת
                    </button>
                </div>
            </div>
            <p id="board-hint" class="hint">בחר תחנה כדי לראות את כל הרכבות הקרובות שעוברות בה.</p>
            <div id="board-body" class="results-body">
                <div class="empty-state">אין נתונים להצגה</div>
            </div>
        </section>

        <footer class="site-credit" aria-label="credit">
            Created by Itamar Yehuda
        </footer>
    </main>
    
    <div id="station-suggestions" class="station-suggestions" hidden></div>

    <script>
        let stations = [];
        let stationsByLabel = new Map();
        let boardRowsRaw = [];
        let boardStationCurrent = null;
        const activeRequests = {
            search: 0,
            board: 0,
        };
        let activeSuggestionInput = null;
        const MIN_CHARS_FOR_SUGGESTIONS = 3;
        const THEME_STORAGE_KEY = 'rail_theme_mode';

        function stationLabel(station) {
            if (station.heb && station.eng) return `${station.heb} | ${station.eng} (${station.id})`;
            return `${station.name} (${station.id})`;
        }

        function parseStationInput(rawValue) {
            const value = (rawValue || '').trim();
            if (!value) return null;

            if (stationsByLabel.has(value)) {
                return stationsByLabel.get(value);
            }

            const normalized = value.toLowerCase();
            const directId = Number(normalized);
            if (!Number.isNaN(directId)) {
                const byId = stations.find(s => s.id === directId);
                if (byId) return byId;
            }

            const candidate = stations.find(s => {
                const name = String(s.name || '').toLowerCase();
                const heb = String(s.heb || '').toLowerCase();
                const eng = String(s.eng || '').toLowerCase();
                return name.includes(normalized) || heb.includes(normalized) || eng.includes(normalized);
            });

            return candidate || null;
        }

        function formatTime(value) {
            if (!value) return '--:--';
            if (value.includes('T')) {
                const parts = value.split('T');
                if (parts[1] && parts[1].length >= 5) return parts[1].slice(0, 5);
            }
            if (value.length >= 5 && value.includes(':')) return value.slice(0, 5);
            return '--:--';
        }

        function tripDayLabel(value) {
            if (!value) return '';
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) return '';
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tripDate = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            const diffDays = Math.round((tripDate - today) / 86400000);
            if (diffDays === 0) return '';
            if (diffDays === 1) return 'מחר';
            return `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}`;
        }

        function routeStops(route) {
            const allStops = [];
            route.trains.forEach(train => train.stops.forEach(stop => allStops.push(stop)));
            return allStops.filter((s, i) => i === 0 || s.name !== allStops[i - 1].name);
        }

        function minutesBetween(fromIso, toIso) {
            const from = new Date(fromIso);
            const to = new Date(toIso);
            if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) return null;
            return Math.max(0, Math.round((to - from) / 60000));
        }

        function formatDurationMinutes(totalMinutes) {
            if (totalMinutes === null) return 'משך נסיעה: --';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            if (hours && minutes) return `משך נסיעה: ${hours}ש ${minutes}דק'`;
            if (hours) return `משך נסיעה: ${hours}ש`;
            return `משך נסיעה: ${minutes} דק'`;
        }

        function realtimeDelayLabel(delayMinutes, hasRealtime) {
            if (delayMinutes === null || delayMinutes === undefined || Number.isNaN(delayMinutes)) {
                return hasRealtime ? { text: 'זמן אמת', cls: 'neutral' } : null;
            }
            if (delayMinutes > 0) return { text: `איחור +${delayMinutes}`, cls: 'late' };
            if (delayMinutes < 0) return { text: `מקדים ${Math.abs(delayMinutes)}`, cls: 'early' };
            return { text: 'בזמן', cls: 'ontime' };
        }

        function normalizeStationName(value) {
            return String(value || '')
                .trim()
                .replace(/\s+/g, ' ')
                .replace(/[–—]/g, '-')
                .toLowerCase();
        }

        function isSearchedBoardStationStop(stop) {
            if (!boardStationCurrent || !stop) return false;

            const searchedId = String(boardStationCurrent.id || '').trim();
            const stopId = String(stop.id || '').trim();
            if (searchedId && stopId && searchedId === stopId) {
                return true;
            }

            const searchedName = normalizeStationName(boardStationCurrent.name);
            const stopName = normalizeStationName(stop.name);
            return Boolean(searchedName && stopName && searchedName === stopName);
        }

        function routeRealtimeLabel(route) {
            const trains = Array.isArray(route?.trains) ? route.trains : [];
            const hasRealtime = trains.some(t => t?.has_realtime);
            const delays = trains
                .map(t => Number(t?.delay_minutes))
                .filter(v => Number.isFinite(v));

            if (!delays.length) {
                return hasRealtime ? { text: 'זמן אמת', cls: 'neutral' } : null;
            }
            const maxDelay = Math.max(...delays);
            const minDelay = Math.min(...delays);
            if (maxDelay > 0) return { text: `איחור +${maxDelay}`, cls: 'late' };
            if (minDelay < 0) return { text: `מקדים ${Math.abs(minDelay)}`, cls: 'early' };
            return { text: 'בזמן', cls: 'ontime' };
        }

        function boardLineAccent(row) {
            const palette = ['#0a65cc', '#f06a00', '#0f9d58', '#d14343', '#0b8ea8', '#9a5a0b'];
            const trainNum = Number(row.train_number);
            if (Number.isFinite(trainNum) && trainNum > 0) {
                return palette[trainNum % palette.length];
            }
            const key = String(row.line_name || `${row.src || ''}-${row.dest || ''}`);
            let hash = 0;
            for (let i = 0; i < key.length; i += 1) {
                hash = ((hash << 5) - hash) + key.charCodeAt(i);
                hash |= 0;
            }
            return palette[Math.abs(hash) % palette.length];
        }

        function transferRows(route) {
            if (!route.trains || route.trains.length < 2) return [];
            const rows = [];
            for (let i = 0; i < route.trains.length - 1; i += 1) {
                const current = route.trains[i];
                const next = route.trains[i + 1];
                const station = current.dst || next.src || 'תחנה לא ידועה';
                const fromPlatform = current.dst_platform || (current.stops?.[current.stops.length - 1]?.platform) || '-';
                const toPlatform = next.platform || (next.stops?.[0]?.platform) || '-';
                const wait = minutesBetween(current.arrival, next.departure);
                rows.push({
                    station,
                    fromPlatform,
                    toPlatform,
                    wait,
                });
            }
            return rows;
        }

        function stopsWithTransferMarkers(route) {
            const stops = routeStops(route);
            const transfers = transferRows(route);
            if (!transfers.length) {
                return stops.map(stop => ({ type: 'stop', stop }));
            }

            const markersByStation = new Map();
            transfers.forEach((transfer, idx) => {
                const key = transfer.station;
                if (!markersByStation.has(key)) markersByStation.set(key, []);
                markersByStation.get(key).push({
                    ...transfer,
                    index: idx + 1,
                });
            });

            const items = [];
            stops.forEach(stop => {
                items.push({ type: 'stop', stop });
                const markers = markersByStation.get(stop.name) || [];
                markers.forEach(marker => items.push({ type: 'transfer', marker }));
            });

            return items;
        }

        async function fetchJson(url) {
            const response = await fetch(url);
            const payload = await response.json();
            if (!response.ok) throw new Error(payload.error || 'Request failed');
            return payload;
        }

        function showLoading(target, text) {
            activeRequests[target] += 1;
            const overlay = document.getElementById(`loading-overlay-${target}`);
            const label = document.getElementById(`loading-text-${target}`);
            label.textContent = text || 'טוען נתונים...';
            overlay.style.display = 'flex';
        }

        function hideLoading(target) {
            activeRequests[target] = Math.max(0, activeRequests[target] - 1);
            if (activeRequests[target] === 0) {
                document.getElementById(`loading-overlay-${target}`).style.display = 'none';
            }
        }

        function hideBootSplash() {
            const splash = document.getElementById('boot-splash');
            if (!splash || splash.dataset.hidden === '1') return;
            splash.dataset.hidden = '1';
            splash.classList.add('boot-splash-hidden');
            setTimeout(() => {
                splash.style.display = 'none';
            }, 280);
        }

        async function loadStations() {
            const hint = document.getElementById('search-hint');
            try {
                stations = await fetchJson('/api/stations');
                stationsByLabel = new Map();

                stations.forEach(station => {
                    const label = stationLabel(station);
                    stationsByLabel.set(label, station);
                });

                hint.textContent = `נטענו ${stations.length} תחנות.`;
            } catch (error) {
                console.error(error);
                hint.textContent = 'שגיאה בטעינת תחנות. רענן את הדף.';
            }
        }

        function filteredStations(query) {
            const q = (query || '').trim().toLowerCase();
            const mobile = window.matchMedia('(max-width: 768px)').matches;
            const limit = mobile ? 9999 : 18;
            if (!q) return stations.slice(0, mobile ? 4 : 12);
            return stations.filter(s => {
                const name = String(s.name || '').toLowerCase();
                const heb = String(s.heb || '').toLowerCase();
                const eng = String(s.eng || '').toLowerCase();
                const id = String(s.id || '');
                return name.includes(q) || heb.includes(q) || eng.includes(q) || id.includes(q);
            }).slice(0, limit);
        }

        function hideSuggestions() {
            const box = document.getElementById('station-suggestions');
            box.hidden = true;
            box.innerHTML = '';
            activeSuggestionInput = null;
        }

        function positionSuggestions(input) {
            const box = document.getElementById('station-suggestions');
            const mobile = window.matchMedia('(max-width: 768px)').matches;
            if (mobile) {
                const viewport = window.visualViewport;
                const viewportTop = viewport ? viewport.offsetTop : 0;
                const viewportHeight = viewport ? viewport.height : window.innerHeight;
                const viewportBottom = viewportTop + viewportHeight;
                box.classList.add('mobile');
                box.style.right = 'auto';
                box.style.bottom = 'auto';

                const rect = input.getBoundingClientRect();
                const sidePadding = 8;
                const gap = 2;
                const maxHeight = Math.max(96, Math.min(170, Math.floor(viewportHeight * 0.30)));
                const spaceBelow = viewportBottom - rect.bottom - gap - sidePadding;
                const spaceAbove = rect.top - viewportTop - gap - sidePadding;

                const dropWidth = Math.min(rect.width, window.innerWidth - (sidePadding * 2));
                const left = Math.max(sidePadding, Math.min(rect.left, window.innerWidth - dropWidth - sidePadding));

                box.style.left = `${left}px`;
                box.style.width = `${dropWidth}px`;

                if (spaceBelow >= 110 || spaceBelow >= spaceAbove) {
                    const h = Math.max(96, Math.min(maxHeight, Math.floor(spaceBelow)));
                    box.style.maxHeight = `${h}px`;
                    box.style.top = `${Math.max(viewportTop + sidePadding, rect.bottom + gap)}px`;
                } else {
                    const h = Math.max(96, Math.min(maxHeight, Math.floor(spaceAbove)));
                    box.style.maxHeight = `${h}px`;
                    box.style.top = `${Math.max(viewportTop + sidePadding, rect.top - h - gap)}px`;
                }
                return;
            }

            const rect = input.getBoundingClientRect();
            box.classList.remove('mobile');
            box.style.left = `${rect.left + window.scrollX}px`;
            box.style.top = `${rect.bottom + window.scrollY + 6}px`;
            box.style.bottom = 'auto';
            box.style.right = 'auto';
            box.style.width = `${rect.width}px`;
            box.style.maxHeight = 'min(48vh, 340px)';
        }

        function showSuggestions(input) {
            if (!stations.length) return;
            const value = (input.value || '').trim();
            if (value.length < MIN_CHARS_FOR_SUGGESTIONS) {
                hideSuggestions();
                return;
            }
            const box = document.getElementById('station-suggestions');
            const options = filteredStations(input.value);
            if (!options.length) {
                hideSuggestions();
                return;
            }

            activeSuggestionInput = input;
            box.innerHTML = options.map(s => {
                const label = stationLabel(s);
                return `<button type="button" class="station-option" data-station-label="${label.replace(/"/g, '&quot;')}">${label}</button>`;
            }).join('');

            positionSuggestions(input);
            box.hidden = false;

            const selectSuggestion = (btn) => {
                if (!btn) return;
                input.value = btn.dataset.stationLabel || btn.textContent || '';
                hideSuggestions();
                input.dispatchEvent(new Event('change'));
            };

            box.querySelectorAll('.station-option').forEach(btn => {
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    selectSuggestion(btn);
                });
                btn.addEventListener('click', () => {
                    selectSuggestion(btn);
                });
            });
        }

        function setResultsHeader(fromName, toName, count) {
            document.getElementById('results-header').style.display = 'flex';
            document.getElementById('results-title').textContent = `${fromName} ← ${toName}`;
            document.getElementById('results-count').textContent = `${count} נסיעות`;
        }

        function renderResults(routes) {
            const body = document.getElementById('results-body');
            if (!routes.length) {
                body.innerHTML = '<div class="empty-state">לא נמצאו נסיעות עבור הבחירה הזו.</div>';
                return;
            }

            body.innerHTML = routes.map((route, idx) => {
                const timeline = stopsWithTransferMarkers(route);
                const transfers = transferRows(route);
                const stopCount = timeline.filter(item => item.type === 'stop').length;
                const durationMinutes = minutesBetween(route.start_time, route.end_time);
                const durationShort = durationMinutes === null ? '--' : `${durationMinutes} דק'`;
                const dayLabel = tripDayLabel(route.start_time);
                const realtimeStatus = routeRealtimeLabel(route);
                const firstTrain = Array.isArray(route.trains) && route.trains.length ? route.trains[0] : null;
                const lastTrain = Array.isArray(route.trains) && route.trains.length ? route.trains[route.trains.length - 1] : null;
                const transferCount = Math.max(0, (route.trains?.length || 1) - 1);
                const transferLabel = transferCount === 0 ? 'ללא החלפות' : `${transferCount} החלפות`;
                const startPlatform = firstTrain?.platform || '-';
                const endPlatform = lastTrain?.dst_platform || '-';
                const trainNumber = firstTrain?.train_number || '-';
                return `
                    <article class="trip-card">
                        <button class="trip-head" onclick="toggleDetails(${idx})">
                            <div class="trip-topline">
                                <span class="trip-train-number">רכבת ${trainNumber}</span>
                                <span class="badge subtle trip-day${dayLabel ? '' : ' trip-day-empty'}">${dayLabel || '&nbsp;'}</span>
                            </div>
                            <div class="trip-mainline">
                                <div class="trip-side">
                                    <strong class="trip-time">${formatTime(route.start_time)}</strong>
                                    <span class="trip-platform">רציף ${startPlatform}</span>
                                </div>
                                <div class="trip-center">
                                    <span class="trip-duration-pill">${durationShort}</span>
                                    <span class="trip-transfer-label">${transferLabel}</span>
                                </div>
                                <div class="trip-side">
                                    <strong class="trip-time">${formatTime(route.end_time)}</strong>
                                    <span class="trip-platform">רציף ${endPlatform}</span>
                                </div>
                            </div>
                            <div class="trip-bottomline">
                                <span class="badge subtle trip-stat">${stopCount} תחנות</span>
                                ${realtimeStatus ? `<span class="board-delay ${realtimeStatus.cls}">${realtimeStatus.text}</span>` : '<span></span>'}
                            </div>
                            <i data-lucide="chevron-down" size="16" class="trip-expand"></i>
                        </button>
                        <div id="trip-details-${idx}" class="trip-details">
                            ${transfers.map((t, transferIdx) => `
                                <div class="transfer-note">
                                    <strong>החלפה ${transferIdx + 1}: ${t.station}</strong>
                                    <span>רציף יורדים: ${t.fromPlatform} · רציף עולים: ${t.toPlatform}${t.wait !== null ? ` · המתנה: ${t.wait} דק'` : ''}</span>
                                </div>
                            `).join('')}
                            ${timeline.map(item => `
                                ${item.type === 'stop' ? `
                                <div class="stop-row">
                                    <span>${item.stop.name}</span>
                                    <strong>${formatTime(item.stop.arrival || item.stop.departure)}</strong>
                                </div>
                                ` : `
                                <div class="transfer-row-inline">
                                    <strong>החלפה ${item.marker.index}</strong>
                                    <span>${item.marker.station} · רציף ${item.marker.fromPlatform} → ${item.marker.toPlatform}${item.marker.wait !== null ? ` · ${item.marker.wait} דק'` : ''}</span>
                                </div>
                                `}
                            `).join('')}
                        </div>
                    </article>
                `;
            }).join('');

            lucide.createIcons();
        }

        function renderBoard(rows) {
            const body = document.getElementById('board-body');
            document.getElementById('board-count').textContent = `${rows.length} רכבות`;
            if (!rows.length) {
                body.innerHTML = '<div class="empty-state">לא נמצאו רכבות בטווח הזמן שנבחר.</div>';
                return;
            }

            body.innerHTML = rows.map((row, idx) => {
                const stopsHtml = Array.isArray(row.stops) ? row.stops.map(stop => {
                            const isCurrent = isSearchedBoardStationStop(stop);
                            return `
                            <div class="stop-row${isCurrent ? ' current-station' : ''}">
                                <span${isCurrent ? ' style="font-weight:800"' : ''}>${stop.name}</span>
                                <strong>${formatTime(stop.time)}</strong>
                            </div>
                        `;
                        }).join('') : '';
                return `
                <article class="trip-card board-card" style="--line-accent: ${boardLineAccent(row)}; --card-i: ${idx};">
                    <button class="board-row" onclick="toggleBoardDetails(${idx})">
                        <div class="board-main">
                            <div class="board-topline">
                                <strong class="board-line">${row.line_name || `${row.src} - ${row.dest}`}</strong>
                                <span class="board-destination">לכיוון ${row.dest || '-'}</span>
                            </div>
                            <div class="board-tags">
                                <span class="board-pill">יציאה ${formatTime(row.effective_time || row.time)}</span>
                                ${row.effective_time && formatTime(row.effective_time) !== formatTime(row.time)
                                    ? `<span class="board-pill">מתוכנן ${formatTime(row.time)}</span>`
                                    : ''}
                                <span class="board-pill">רציף ${row.platform || '-'}</span>
                                <span class="board-pill">רכבת ${row.train_number || '-'}</span>
                            </div>
                        </div>
                        <div class="board-time" style="min-width:72px;flex:0 0 72px;">
                            <span class="eta-minutes">${row.effective_eta_minutes ?? row.eta_minutes ?? '?'}</span>
                            <span class="eta-unit" style="white-space:nowrap;">דק'</span>
                            ${(() => {
                                const status = realtimeDelayLabel(row.delay_minutes, row.has_realtime);
                                return status ? `<span class="board-delay ${status.cls}" style="white-space:nowrap;">${status.text}</span>` : '';
                            })()}
                        </div>
                        <i data-lucide="chevron-down" size="16" style="flex:0 0 auto;"></i>
                    </button>
                    <div id="board-details-${idx}" class="board-details">
                        <div class="board-details-head">תחנות במסלול</div>
                        ${stopsHtml}
                        <div class="board-meta">קו ${row.line_name || `${row.src} - ${row.dest}`}</div>
                    </div>
                </article>
            `;
            }).join('');

            lucide.createIcons();
        }

        function applyBoardFilter() {
            renderBoard(boardRowsRaw);
        }

        function toggleBoardDetails(idx) {
            const details = document.getElementById(`board-details-${idx}`);
            const isOpen = details.style.display === 'block';

            document.querySelectorAll('.board-details').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.board-row i').forEach(icon => icon.style.transform = 'rotate(0deg)');

            if (!isOpen) {
                details.style.display = 'block';
                const icon = details.previousElementSibling.querySelector('i');
                icon.style.transform = 'rotate(180deg)';
                icon.style.transition = 'transform 0.2s ease';
            }
        }

        function toggleDetails(idx) {
            const details = document.getElementById(`trip-details-${idx}`);
            const isOpen = details.style.display === 'block';

            document.querySelectorAll('.trip-details').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.trip-head i').forEach(icon => icon.style.transform = 'rotate(0deg)');

            if (!isOpen) {
                details.style.display = 'block';
                const icon = details.previousElementSibling.querySelector('i');
                icon.style.transform = 'rotate(180deg)';
                icon.style.transition = 'transform 0.2s ease';
            }
        }

        async function runSearch(forceAllDay) {
            const fromInput = document.getElementById('from-input').value;
            const toInput = document.getElementById('to-input').value;
            const fromStation = parseStationInput(fromInput);
            const toStation = parseStationInput(toInput);

            const body = document.getElementById('results-body');
            const hint = document.getElementById('search-hint');

            if (!fromStation || !toStation) {
                hint.textContent = 'בחר תחנות מתוך הרשימה (או הקלד שם מדויק/חלקי).';
                return;
            }

            if (fromStation.id === toStation.id) {
                hint.textContent = 'תחנת מוצא ויעד חייבות להיות שונות.';
                return;
            }

            const date = document.getElementById('date-picker').value;
            const time = forceAllDay ? '00:00' : document.getElementById('time-picker').value;
            const url = `/api/routes/${fromStation.id}/${toStation.id}?date=${date}&time=${time}`;

            document.getElementById('results-header').style.display = 'flex';
            body.innerHTML = '<div class="loading">טוען נסיעות...</div>';
            hint.textContent = 'מבצע חיפוש...';
            document.getElementById('results-count').textContent = 'מחפש...';
            showLoading('search', 'מחפש נסיעות...');

            try {
                const routes = await fetchJson(url);
                setResultsHeader(fromStation.name, toStation.name, routes.length);
                renderResults(routes);
                hint.textContent = forceAllDay ? 'מציג את כל הנסיעות ליום הנבחר.' : 'מציג נסיעות החל מהשעה שנבחרה.';
            } catch (error) {
                console.error(error);
                body.innerHTML = '<div class="empty-state">שגיאה בטעינת הנתונים. נסה שוב.</div>';
                hint.textContent = `שגיאה: ${error.message}`;
            } finally {
                hideLoading('search');
            }
        }

        async function runStationRealtime() {
            const stationInput = document.getElementById('board-station-input').value;
            const station = parseStationInput(stationInput);
            const minutes = document.getElementById('board-window').value;
            const hint = document.getElementById('board-hint');
            const body = document.getElementById('board-body');

            if (!station) {
                hint.textContent = 'בחר תחנה מתוך הרשימה (או הקלד שם מדויק/חלקי).';
                return;
            }

            body.innerHTML = '<div class="loading">טוען זמן אמת...</div>';
            hint.textContent = `מחפש רכבות ל-${minutes} הדקות הקרובות...`;
            document.getElementById('board-count').textContent = 'מחפש...';
            showLoading('board', 'מעדכן זמן אמת...');

            try {
                const rows = await fetchJson(`/api/station-board/${station.id}?upcoming=1&minutes=${minutes}&fast=1`);
                boardRowsRaw = rows;
                boardStationCurrent = station;
                applyBoardFilter();
                hint.textContent = `זמן אמת לתחנה: ${station.name}`;
            } catch (error) {
                console.error(error);
                body.innerHTML = '<div class="empty-state">שגיאה בטעינת זמן אמת. נסה שוב.</div>';
                hint.textContent = `שגיאה: ${error.message}`;
            } finally {
                hideLoading('board');
            }
        }

        function swapStations() {
            const from = document.getElementById('from-input');
            const to = document.getElementById('to-input');
            const temp = from.value;
            from.value = to.value;
            to.value = temp;
        }

        function initDateTime() {
            const now = new Date();
            document.getElementById('date-picker').valueAsDate = now;
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('time-picker').value = `${hh}:${mm}`;
        }

        function applyThemeMode(mode) {
            const root = document.documentElement;
            if (mode === 'dark' || mode === 'light') {
                root.setAttribute('data-theme', mode);
            } else {
                root.removeAttribute('data-theme');
            }

            const labels = {
                auto: 'אוטומטי',
                dark: 'כהה',
                light: 'בהיר',
            };
            const btn = document.getElementById('theme-toggle');
            if (btn) btn.innerHTML = `<i data-lucide="sun-moon" size="16"></i> תצוגה: ${labels[mode] || labels.auto}`;
            lucide.createIcons();
        }

        function initThemeToggle() {
            const btn = document.getElementById('theme-toggle');
            const stored = localStorage.getItem(THEME_STORAGE_KEY) || 'auto';
            applyThemeMode(stored);
            if (!btn) return;
            btn.addEventListener('click', () => {
                const current = localStorage.getItem(THEME_STORAGE_KEY) || 'auto';
                const order = ['auto', 'dark', 'light'];
                const next = order[(order.indexOf(current) + 1) % order.length];
                localStorage.setItem(THEME_STORAGE_KEY, next);
                applyThemeMode(next);
            });
        }

        document.getElementById('swap-btn').addEventListener('click', swapStations);
        document.getElementById('search-btn').addEventListener('click', () => runSearch(false));
        document.getElementById('all-day-btn').addEventListener('click', () => runSearch(true));
        document.getElementById('board-btn').addEventListener('click', runStationRealtime);

        document.getElementById('from-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') runSearch(false);
        });
        document.getElementById('to-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') runSearch(false);
        });
        document.getElementById('board-station-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') runStationRealtime();
        });

        ['from-input', 'to-input', 'board-station-input'].forEach((id) => {
            const input = document.getElementById(id);
            const selectAllIfHasValue = () => {
                if (!input.value || !input.value.trim()) return;
                input.select();
            };
            input.addEventListener('focus', () => {
                if (window.matchMedia('(max-width: 768px)').matches) {
                    setTimeout(() => {
                        input.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }, 80);
                }
                setTimeout(selectAllIfHasValue, 0);
                showSuggestions(input);
            });
            input.addEventListener('click', selectAllIfHasValue);
            input.addEventListener('input', () => showSuggestions(input));
            input.addEventListener('blur', () => setTimeout(hideSuggestions, 120));
        });

        document.addEventListener('scroll', () => {
            if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
        }, true);
        window.addEventListener('resize', () => {
            if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
        });
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
            });
            window.visualViewport.addEventListener('scroll', () => {
                if (activeSuggestionInput) positionSuggestions(activeSuggestionInput);
            });
        }

        initThemeToggle();
        initDateTime();
        loadStations().then(() => {
            document.getElementById('search-hint').textContent = 'בחר תחנת מוצא ותחנת יעד כדי להתחיל חיפוש.';
        }).finally(() => {
            hideBootSplash();
        });

        window.addEventListener('load', () => {
            setTimeout(hideBootSplash, 300);
        });
        setTimeout(hideBootSplash, 6000);

        lucide.createIcons();
    </script>
</body>

</html>


